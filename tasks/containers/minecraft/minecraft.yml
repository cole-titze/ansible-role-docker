---
- name: Create Minecraft Bedrock data directory
  ansible.builtin.file:
    path: "/opt/minecraft-bedrock"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Check if Ipad world already exists
  ansible.builtin.stat:
    path: "/opt/minecraft-bedrock/worlds/Ipad"
  register: ipad_world

# -------- RESTORE ONLY IF WORLD IS MISSING --------

- name: Find local Minecraft backups
  ansible.builtin.find:
    paths: "{{ lookup('env', 'HOME') }}/source/ansible-files/backups/minecraft/bedrock"
    patterns: "*.zip"
  delegate_to: localhost
  register: local_backups
  when: not ipad_world.stat.exists

- name: Fail if no backups exist
  ansible.builtin.fail:
    msg: "No Minecraft backups found to restore from"
  when:
    - not ipad_world.stat.exists
    - local_backups.matched == 0

- name: Select newest local backup
  ansible.builtin.set_fact:
    newest_backup: >-
      {{ local_backups.files
          | sort(attribute='mtime', reverse=true)
          | first }}
  when: not ipad_world.stat.exists

- name: Copy newest backup to Pi
  ansible.builtin.copy:
    src: "{{ newest_backup.path }}"
    dest: "/tmp/minecraft_restore.zip"
    mode: "0644"
  when: not ipad_world.stat.exists

- name: Ensure worlds directory exists
  ansible.builtin.file:
    path: "/opt/minecraft-bedrock/worlds"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"
  when: not ipad_world.stat.exists

- name: Restore Minecraft world from backup
  ansible.builtin.unarchive:
    src: "/tmp/minecraft_restore.zip"
    dest: "/opt/minecraft-bedrock/worlds"
    remote_src: true
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: not ipad_world.stat.exists

- name: Remove temporary restore zip
  ansible.builtin.file:
    path: "/tmp/minecraft_restore.zip"
    state: absent
  when: not ipad_world.stat.exists

# -------- DEPLOY CONTAINER --------

- name: Ensure latest Minecraft Bedrock image is pulled
  community.docker.docker_image:
    name: itzg/minecraft-bedrock-server:latest
    source: pull

- name: Deploy Minecraft Bedrock Server container
  community.docker.docker_container:
    name: minecraft-bedrock
    image: itzg/minecraft-bedrock-server:latest
    state: started
    restart_policy: unless-stopped
    ports:
      - "19132:19132/udp"
    volumes:
      - "/opt/minecraft-bedrock:/data"
    env:
      EULA: "TRUE"
      SERVER_NAME: "Bedrock Server"
      GAMEMODE: "survival"
      DIFFICULTY: "easy"
      LEVEL_NAME: "Ipad"
      ONLINE_MODE: "true"
      ALLOW_CHEATS: "false"
      MAX_PLAYERS: "10"
      VIEW_DISTANCE: "10"
      SIMULATION_DISTANCE: "6"
    user: "1000:1000"

# Setup nightly updates
- name: Copy Minecraft update script
  ansible.builtin.copy:
    src: files/containers/minecraft.sh
    dest: /usr/local/bin/minecraft.sh
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Ensure update script is executable
  ansible.builtin.file:
    path: /usr/local/bin/minecraft.sh
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: file

- name: Schedule Minecraft update via cron
  ansible.builtin.cron:
    name: "Update Minecraft Docker container"
    minute: "0"
    hour: "3"
    job: "/bin/bash /usr/local/bin/minecraft.sh"
    user: "{{ ansible_user }}"
    state: present
  diff: no